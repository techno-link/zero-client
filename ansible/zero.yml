---
- name: "configure zero client"
  hosts: localhost
  connection: local
  gather_facts: yes
  vars:
    gitpath: https://raw.githubusercontent.com/techno-link/zero-client/master/

  handlers:
    - name: Reload systemd and restart getty@tty1
      ansible.builtin.systemd:
        daemon_reload: yes
        name: getty@tty1
        state: restarted

    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: yes


  tasks:
    # ------------------------------------------------------------------------------------------------------------------
    # UPDATE AND CLEANUP APT
    # ------------------------------------------------------------------------------------------------------------------
    - name: Add the Universe repository
      ansible.builtin.apt_repository:
        repo: 'deb http://archive.ubuntu.com/ubuntu {{ ansible_distribution_release }} universe'
        state: present
        update_cache: yes

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes

    - name: Upgrade all packages to the latest version
      ansible.builtin.apt:
        name: "*"
        state: latest

    - name: Remove useless packages from the cache and purge
      ansible.builtin.apt:
        autoclean: yes

    - name: Remove dependencies that are no longer required
      ansible.builtin.apt:
        autoremove: yes
        purge: yes

    # ------------------------------------------------------------------------------------------------------------------
    # CONFIGURE TTY AND AUTOLOGIN
    # ------------------------------------------------------------------------------------------------------------------
    - name: Ensure the getty@tty1 override directory exists
      ansible.builtin.file:
        path: /etc/systemd/system/getty@tty1.service.d
        state: directory
        mode: '0755'

    - name: Configure autologin for tty1
      ansible.builtin.lineinfile:
        path: /etc/systemd/system/getty@tty1.service.d/override.conf
        create: yes
        regexp: '^ExecStart='
        line: 'ExecStart=-/sbin/agetty --autologin zero --noclear %I 38400 linux'
        owner: root
        group: root
        mode: '0644'
      notify: Reload systemd and restart getty@tty1

    - name: Disable other TTYs (tty2-tty6)
      ansible.builtin.systemd:
        name: getty@tty{{ item }}
        enabled: no
        masked: yes
        state: stopped
      loop: [2, 3, 4, 5, 6]
      notify: Reload systemd

    # ------------------------------------------------------------------------------------------------------------------
    # OPENBOX AND GUI
    # ------------------------------------------------------------------------------------------------------------------
    - name: Install Openbox and related packages
      ansible.builtin.apt:
        name:
          - openbox
          - xterm
        state: latest

    - name: Install audio software
      ansible.builtin.apt:
        name:
          - pulseaudio
          - pavucontrol
          - alsa-base
          - alsa-utils
          - linux-sound-base
          - libasound2
        state: latest

    - name: Check if .bash_profile exists
      ansible.builtin.stat:
        path: "/home/zero/.bash_profile"
      register: bash_profile

    - name: Add X server start script to .bash_profile
      ansible.builtin.lineinfile:
        path: "/home/zero/.bash_profile"
        create: yes
        line: |
          if [[ -z $DISPLAY ]] && [[ $(tty) = /dev/tty1 ]]; then
              startx
          fi
        mode: '0644'
        owner: zero
        group: zero

    - name: Configure .xinitrc to start Openbox
      ansible.builtin.copy:
        dest: "/home/zero/.xinitrc"
        content: "exec openbox-session\n"
        mode: '0644'
        owner: zero
        group: zero

